<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Club Ratings</title>
    
    <!-- External Libraries -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/responsive/2.4.1/css/responsive.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    
    <style>
        body { background-color: #f0f2f5; font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding-bottom: 60px; }
        
        /* FIX 1: Login Screen is now a FIXED overlay on top of everything */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #e9ecef;
            z-index: 9999; /* Always on top */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .navbar { background: linear-gradient(135deg, #0056b3, #004494); }
        .navbar-brand { font-weight: bold; color: white !important; }
        .card { border-radius: 12px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .elo-badge { background-color: #e3f2fd; color: #0d47a1; font-weight: 800; padding: 4px 8px; border-radius: 6px; }
        .rank-cell { font-weight: bold; color: #666; text-align: center; }
        .vs-badge { width: 40px; height: 40px; background: #eee; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin: 0 auto; }
        #debug-area { display: none; color: red; text-align: center; margin-top: 20px; font-family: monospace; }
    </style>
</head>
<body>

    <!-- LOGIN SCREEN -->
    <div id="login-screen">
        <div class="card p-4 text-center" style="max-width: 350px; width: 90%;">
            <h3 class="mb-3">üèì Club Login</h3>
            <input type="password" id="password-input" class="form-control mb-3" placeholder="Password" style="text-align: center;" onkeydown="if(event.key==='Enter') checkPass()">
            <button onclick="checkPass()" id="login-btn" class="btn btn-primary w-100 fw-bold">ENTER</button>
            <p id="pass-error" class="text-danger mt-2 small" style="display:none;">Incorrect password</p>
            <div id="debug-area"></div>
        </div>
    </div>

    <!-- MAIN APP (FIX 2: Inline style ensures it is hidden on load) -->
    <div id="app-content" style="display: none;">
        <nav class="navbar navbar-dark mb-3">
            <div class="container d-flex justify-content-between">
                <span class="navbar-brand">üèì Club Ratings</span>
                <span class="text-white-50 small" id="last-update">Loading...</span>
            </div>
        </nav>

        <div class="container" id="main-interface">
            <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#rankings">üèÜ Rankings</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#history">üìà History</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#forecast">üîÆ Calculator</button></li>
            </ul>

            <div class="tab-content">
                <!-- RANKINGS -->
                <div class="tab-pane fade show active" id="rankings">
                    <div class="card p-2">
                        <table id="ratingTable" class="table table-hover dt-responsive nowrap" style="width:100%">
                            <thead>
                                <tr><th>#</th><th>Player</th><th>Elo</th><th>Win %</th><th>Games</th><th>6m</th><th>1y</th><th>Last</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- HISTORY -->
                <div class="tab-pane fade" id="history">
                    <div class="card p-3">
                        <label class="form-label fw-bold">Select Players:</label>
                        <select id="player-select" class="form-control" multiple="multiple" style="width: 100%"></select>
                        <div class="mt-3" style="height: 400px;"><canvas id="historyChart"></canvas></div>
                    </div>
                </div>

                <!-- CALCULATOR -->
                <div class="tab-pane fade" id="forecast">
                    <div class="card p-3">
                        <div class="mb-3 text-center">
                            <label class="fw-bold">Match Format:</label>
                            <select id="sets-input" class="form-select w-auto d-inline-block ms-2">
                                <option value="1">Single Game</option>
                                <option value="3">Best of 3</option>
                                <option value="5" selected>Best of 5</option>
                                <option value="7">Best of 7</option>
                            </select>
                        </div>
                        <div class="row g-2 align-items-center">
                            <div class="col-5">
                                <select id="calc-p1" class="form-control select2-single"></select>
                                <div class="text-center mt-2 fw-bold text-primary" id="elo-p1">-</div>
                            </div>
                            <div class="col-2 text-center"><div class="vs-badge">VS</div></div>
                            <div class="col-5">
                                <select id="calc-p2" class="form-control select2-single"></select>
                                <div class="text-center mt-2 fw-bold text-primary" id="elo-p2">-</div>
                            </div>
                        </div>
                        <div class="d-grid gap-2 mt-4"><button onclick="calculateWin()" class="btn btn-success fw-bold">PREDICT</button></div>
                        <div id="result-area" class="mt-4" style="display:none;">
                            <div class="progress" style="height: 25px;">
                                <div id="bar-p1" class="progress-bar bg-primary" style="width: 50%"></div>
                                <div id="bar-p2" class="progress-bar bg-warning" style="width: 50%"></div>
                            </div>
                            <div class="d-flex justify-content-between mt-1 px-1">
                                <span class="fw-bold text-primary" id="prob-p1">50%</span>
                                <span class="fw-bold text-warning" id="prob-p2">50%</span>
                            </div>
                            <hr><ul class="list-group list-group-flush small" id="score-probs"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.4.1/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.4.1/js/responsive.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        const CLUB_PASSWORD = "pingpong"; 
        const DATA_URL = "https://dtdr01.github.io/WHR-TT/ratings_data.json"; 
        
        let GLOBAL_DATA = null;
        let CHART_INSTANCE = null;

        function checkPass() {
            if(document.getElementById('password-input').value === CLUB_PASSWORD) {
                const btn = document.getElementById('login-btn');
                btn.innerText = "Loading Data...";
                btn.disabled = true;
                document.getElementById('pass-error').style.display='none';
                initApp();
            } else {
                document.getElementById('pass-error').style.display='block';
            }
        }

        async function initApp() {
            try {
                // Fetch Data
                const fetchUrl = DATA_URL + '?t=' + new Date().getTime();
                const res = await fetch(fetchUrl);
                if (!res.ok) throw new Error("HTTP " + res.status);
                
                GLOBAL_DATA = await res.json();
                
                // Hide Login (Fixed Overlay), Show App
                document.getElementById('login-screen').style.display='none';
                document.getElementById('app-content').style.display='block';
                document.getElementById('last-update').innerText = "Updated: " + GLOBAL_DATA.meta.updated;

                // 1. Table
                const tData = GLOBAL_DATA.leaderboard.map(p => ["", p.name, p.elo, p.win_pct + "%", p.games, p.games_6m, p.games_1y, p.last_match]);
                
                const table = $('#ratingTable').DataTable({
                    destroy: true,
                    data: tData,
                    pageLength: 25,
                    lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]],
                    responsive: true,
                    order: [[ 2, "desc" ]], 
                    columnDefs: [
                        { targets: 0, className: 'rank-cell' },
                        { targets: 2, render: (d) => `<span class="elo-badge">${d}</span>` }
                    ]
                });

                table.on('order.dt search.dt', function () {
                    table.column(0, {search:'applied', order:'applied'}).nodes().each((cell, i) => cell.innerHTML = i + 1);
                }).draw();

                // 2. Selects
                const names = GLOBAL_DATA.leaderboard.map(p => p.name).sort();
                names.forEach(n => {
                    $('#player-select').append(new Option(n, n));
                    $('#calc-p1').append(new Option(n, n));
                    $('#calc-p2').append(new Option(n, n));
                });

                $('.select2-single').select2({ width: '100%' });
                $('#player-select').select2({ placeholder: "Select players...", width: '100%' });
                
                // Graph Default
                const top5 = GLOBAL_DATA.leaderboard.slice(0, 5).map(p => p.name);
                $('#player-select').val(top5).trigger('change');
                updateChart();
                $('#player-select').on('change', updateChart);

            } catch (e) {
                console.error(e);
                const debug = document.getElementById('debug-area');
                debug.style.display = 'block';
                debug.innerHTML = "FAILED TO LOAD DATA<br>" + e.message;
                const btn = document.getElementById('login-btn');
                btn.innerText = "Try Again";
                btn.disabled = false;
            }
        }

        function updateChart() {
            const ctx = document.getElementById('historyChart').getContext('2d');
            const selected = $('#player-select').val();
            const colors = ['#0d6efd', '#dc3545', '#198754', '#fd7e14', '#6610f2', '#0dcaf0', '#d63384'];
            
            const datasets = selected.map((name, i) => ({
                label: name,
                data: GLOBAL_DATA.history[name],
                borderColor: colors[i % colors.length],
                backgroundColor: colors[i % colors.length],
                borderWidth: 2,
                pointRadius: 0,
                tension: 0.3
            })).filter(d => d.data);

            if(CHART_INSTANCE) CHART_INSTANCE.destroy();
            CHART_INSTANCE = new Chart(ctx, {
                type: 'line',
                data: { datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: { type: 'time', time: { unit: 'month' } } },
                    plugins: { tooltip: { mode: 'index', intersect: false } }
                }
            });
        }

        function calculateWin() {
            const p1 = GLOBAL_DATA.leaderboard.find(p => p.name === $('#calc-p1').val());
            const p2 = GLOBAL_DATA.leaderboard.find(p => p.name === $('#calc-p2').val());
            if(!p1 || !p2) return;

            $('#elo-p1').text(p1.elo); $('#elo-p2').text(p2.elo);
            const target = Math.ceil(parseInt($('#sets-input').val()) / 2);
            const p = 1 / (1 + Math.pow(10, (p2.elo - p1.elo) / 400));
            
            let prob1 = 0, scores = [];
            for (let k=0; k<target; k++) {
                let w = combinations(target+k-1, k) * Math.pow(p, target) * Math.pow(1-p, k);
                prob1 += w; scores.push({s:`${target}-${k}`, p:w, w:p1.name});
            }
            for (let k=0; k<target; k++) {
                let w = combinations(target+k-1, k) * Math.pow(1-p, target) * Math.pow(p, k);
                scores.push({s:`${k}-${target}`, p:w, w:p2.name});
            }
            scores.sort((a,b)=>b.p-a.p);

            const pct1 = (prob1 * 100).toFixed(1);
            $('#bar-p1').css('width', pct1+'%').text(p1.name);
            $('#bar-p2').css('width', (100-pct1)+'%').text(p2.name);
            $('#prob-p1').text(pct1+'%'); $('#prob-p2').text((100-pct1).toFixed(1)+'%');

            $('#score-probs').empty();
            scores.slice(0, 5).forEach(sc => {
                let clr = sc.w === p1.name ? 'text-primary' : 'text-warning';
                $('#score-probs').append(`<li class="list-group-item d-flex justify-content-between">
                    <span class="${clr} fw-bold">${sc.s} (${sc.w})</span>
                    <span class="badge bg-secondary rounded-pill">${(sc.p*100).toFixed(1)}%</span>
                </li>`);
            });
            $('#result-area').fadeIn();
        }

        function combinations(n, r) {
            if (r===0 || r===n) return 1; if (r>n) return 0;
            let res = 1; for (let i=1; i<=r; i++) res = res * (n-i+1)/i; return res;
        }
    </script>
</body>
</html>
